name: Build-GeoSite-Manual

on:
  workflow_dispatch: # –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # –í–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–∞–º–∏

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Prepare Environment
        run: |
          mkdir -p data
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π RELEASE_DATE
          echo "RELEASE_DATE=$(TZ='Europe/Moscow' date +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          echo "üìä Files to pack:"
          ls data/

      - name: Create Generator Script
        run: |
          cat <<EOF > builder.go
          package main
          import (
          	"bufio"
          	"encoding/binary"
          	"fmt"
          	"log"
          	"os"
          	"path/filepath"
          	"strings"
          )
          func writeVarint(v uint32) []byte {
          	var buf [binary.MaxVarintLen32]byte
          	n := binary.PutUvarint(buf[:], uint64(v))
          	return buf[:n]
          }
          func encodeField(num int, wireType int, data []byte) []byte {
          	tag := uint32((num << 3) | wireType)
          	res := writeVarint(tag)
          	if wireType == 2 {
          		res = append(res, writeVarint(uint32(len(data)))...)
          	}
          	res = append(res, data...)
          	return res
          }
          func main() {
          	var allEntries []byte
          	files, err := os.ReadDir("./data")
          	if err != nil { log.Fatal(err) }
          	for _, f := range files {
          		if f.IsDir() || strings.HasPrefix(f.Name(), ".") { continue }
          		tagName := strings.ToLower(f.Name())
          		fmt.Printf("Packing category: %s\n", tagName)
          		var sitesData []byte
          		file, _ := os.Open(filepath.Join("./data", f.Name()))
          		scanner := bufio.NewScanner(file)
          		for scanner.Scan() {
          			line := strings.TrimSpace(scanner.Text())
          			if line == "" || strings.HasPrefix(line, "#") { continue }
          			domainType := "domain"
          			domainValue := line
          			if strings.Contains(line, ":") {
          				parts := strings.SplitN(line, ":", 2)
          				prefix := parts[0]
          				if prefix == "domain" || prefix == "full" || prefix == "regexp" || prefix == "keyword" {
          					domainType = prefix
          					domainValue = parts[1]
          				}
          			}
          			siteEntry := encodeField(1, 2, []byte(domainType))
          			siteEntry = append(siteEntry, encodeField(2, 2, []byte(domainValue))...)
          			sitesData = append(sitesData, encodeField(2, 2, siteEntry)...)
          		}
          		file.Close()
          		geoSite := encodeField(1, 2, []byte(tagName))
          		geoSite = append(geoSite, sitesData...)
          		allEntries = append(allEntries, encodeField(1, 2, geoSite)...)
          	}
          	os.WriteFile("geosite.dat", allEntries, 0644)
          }
          EOF

      - name: Run Generator
        run: go run builder.go

      - name: Generate Checksum
        run: sha256sum geosite.dat > geosite.dat.sha256sum

      - name: Re-create Release Tag
        run: |
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–µ–≥ –ª–æ–∫–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–Ω–æ, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º—è –≤ GitHub
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -d latest || true
          git push origin :refs/tags/latest || true
          git tag latest
          git push origin latest

      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "GeoSite Build: ${{ env.RELEASE_DATE }}"
          body: |
            ## üöÄ Manual GeoSite Build
            **Build Date:** ${{ env.RELEASE_DATE }}
            
            ### üì¶ Included categories:
            ```
            $(ls data/)
            ```
          draft: false
          prerelease: false
          make_latest: true
          files: |
            geosite.dat
            geosite.dat.sha256sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
