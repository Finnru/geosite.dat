name: Build-GeoIP-Raw

on:
  workflow_dispatch: # Позволяет запускать вручную
  schedule:
    - cron: "0 0 */1 * *" 
  push:
    branches: [master, main]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Prepare Data (ipdeny.com CIDR)
        run: |
          mkdir -p data
          # Генерируем дату для использования в GitHub Actions
          echo "RELEASE_DATE=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          
          echo "Downloading RU IP ranges from ipdeny.com..."
          # Скачиваем зону с IP-диапазонами для России
          curl -s -L "https://www.ipdeny.com/ipblocks/data/countries/ru.zone" -o data/ru
          
          # Проверяем, что файл не пустой
          if [ ! -s data/ru ]; then
            echo "❌ ERROR: Downloaded file is empty!"
            exit 1
          fi
          
          # Очищаем от пустых строк и комментариев
          sed -i '/^$/d' data/ru
          sed -i '/^#/d' data/ru
          
          echo "Found $(wc -l < data/ru) RU ranges."
          echo "Sample of first 5 ranges:"
          head -5 data/ru

      - name: Create Generator Script
        run: |
          cat <<EOF > builder.go
          package main
          import (
          	"bufio"
          	"encoding/binary"
          	"fmt"
          	"log"
          	"net"
          	"os"
          	"path/filepath"
          	"strings"
          )
          func writeVarint(v uint32) []byte {
          	var buf [binary.MaxVarintLen32]byte
          	n := binary.PutUvarint(buf[:], uint64(v))
          	return buf[:n]
          }
          func encodeField(num int, wireType int, data []byte) []byte {
          	tag := uint32((num << 3) | wireType)
          	res := writeVarint(tag)
          	if wireType == 2 {
          		res = append(res, writeVarint(uint32(len(data)))...)
          	}
          	res = append(res, data...)
          	return res
          }
          func main() {
          	var allEntries []byte
          	files, err := os.ReadDir("./data")
          	if err != nil { log.Fatal(err) }
          	for _, f := range files {
          		if f.IsDir() { continue }
          		tag := strings.ToUpper(f.Name())
          		fmt.Printf("Packing tag: %s\n", tag)
          		var cidrsData []byte
          		file, _ := os.Open(filepath.Join("./data", f.Name()))
          		scanner := bufio.NewScanner(file)
          		for scanner.Scan() {
          			line := strings.TrimSpace(scanner.Text())
          			if line == "" || strings.HasPrefix(line, "#") { continue }
          			_, ipnet, err := net.ParseCIDR(line)
          			if err == nil {
          				ip := ipnet.IP.To4()
          				if ip == nil { ip = ipnet.IP.To16() }
          				mask, _ := ipnet.Mask.Size()
          				c := encodeField(1, 2, ip)
          				c = append(c, encodeField(2, 0, writeVarint(uint32(mask)))...)
          				cidrsData = append(cidrsData, encodeField(2, 2, c)...)
          			}
          		}
          		file.Close()
          		geoIPData := encodeField(1, 2, []byte(tag))
          		geoIPData = append(geoIPData, cidrsData...)
          		allEntries = append(allEntries, encodeField(1, 2, geoIPData)...)
          	}
          	os.WriteFile("geoip.dat", allEntries, 0644)
          	fmt.Printf("Generated geoip.dat with %d bytes\n", len(allEntries))
          }
          EOF

      - name: Run Generator
        run: go run builder.go

      - name: Verify Generated File
        run: |
          echo "Checking generated file..."
          if [ ! -f geoip.dat ] || [ ! -s geoip.dat ]; then
            echo "❌ ERROR: geoip.dat was not generated or is empty!"
            exit 1
          fi
          echo "✅ geoip.dat size: $(wc -c < geoip.dat) bytes"

      - name: Generate Checksum
        run: sha256sum geoip.dat > geoip.dat.sha256sum

      - name: Display Checksum
        run: |
          echo "SHA256 Checksum:"
          cat geoip.dat.sha256sum

      - name: Commit and Push Data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/ru
          git commit -m "Update RU IPs [${{ env.RELEASE_DATE }}]" || echo "No changes"
          git push

      - name: Delete Old Release Tag
        run: |
          # Удаляем локальный и удаленный тег, чтобы форсировать обновление даты релиза
          git tag -d latest || true
          git push origin :refs/tags/latest || true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
        with:
          tag_name: latest
          name: "GeoIP Build: ${{ env.RELEASE_DATE }}"
          body: |
            Обновлено автоматически раз в 3 дня.
            
            **Источник:** ipdeny.com
            **Страна:** RU (Россия)
            **Диапазонов:** $(wc -l < data/ru)
            **Дата сборки:** ${{ env.RELEASE_DATE }}
            
            Файл `geoip.dat` содержит бинарную базу IP-диапазонов в формате Protocol Buffers.
          draft: false
          prerelease: false
          make_latest: true
          files: |
            geoip.dat
            geoip.dat.sha256sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
