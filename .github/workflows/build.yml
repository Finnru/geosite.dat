name: Build-GeoSite-Manual

on:
  workflow_dispatch: # –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: Prepare Environment
        run: |
          mkdir -p data
          echo "RELEASE_DATE=$(TZ='Europe/Moscow' date +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          echo "üìä Files to pack:"
          ls data/

      - name: Create Generator Script
        run: |
          cat <<EOF > builder.go
          package main
          import (
          	"bufio"
          	"encoding/binary"
          	"fmt"
          	"log"
          	"os"
          	"path/filepath"
          	"strings"
          )

          // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è Protobuf (Tag + Length + Data)
          func encodeField(num int, wireType int, data []byte) []byte {
          	tag := uint32((num << 3) | wireType)
          	var buf [binary.MaxVarintLen32]byte
          	n := binary.PutUvarint(buf[:], uint64(tag))
          	res := buf[:n]
          	if wireType == 2 {
          		var lBuf [binary.MaxVarintLen32]byte
          		ln := binary.PutUvarint(lBuf[:], uint64(len(data)))
          		res = append(res, lBuf[:ln]...)
          	}
          	return append(res, data...)
          }

          func main() {
          	var allGeoSites []byte
          	files, err := os.ReadDir("./data")
          	if err != nil { log.Fatal(err) }

          	for _, f := range files {
          		if f.IsDir() || strings.HasPrefix(f.Name(), ".") { continue }
          		
          		tagName := strings.ToUpper(f.Name())
          		fmt.Printf("Packing category: %s\n", tagName)
          		
          		var domainsBytes []byte
          		file, _ := os.Open(filepath.Join("./data", f.Name()))
          		scanner := bufio.NewScanner(file)
          		
          		for scanner.Scan() {
          			line := strings.TrimSpace(scanner.Text())
          			if line == "" || strings.HasPrefix(line, "#") { continue }
          			
          			// –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –µ—Å—Ç—å (Domain.value)
          			// –í —Å—Ç—Ä—É–∫—Ç—É—Ä–µ GeoSite Domain: Field 2 - Value (string)
          			domainEntry := encodeField(2, 2, []byte(line))
          			
          			// –î–æ–±–∞–≤–ª—è–µ–º Domain –≤ —Å–ø–∏—Å–æ–∫ GeoSite.domain (Field 2)
          			domainsBytes = append(domainsBytes, encodeField(2, 2, domainEntry)...)
          		}
          		file.Close()

          		// –°–æ–±–∏—Ä–∞–µ–º GeoSite: 
          		// Field 1: country_code (–∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
          		// Field 2: list of domains
          		geoSiteData := encodeField(1, 2, []byte(tagName))
          		geoSiteData = append(geoSiteData, domainsBytes...)
          		
          		// –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ GeoSiteList (Field 1)
          		allGeoSites = append(allGeoSites, encodeField(1, 2, geoSiteData)...)
          	}

          	os.WriteFile("geosite.dat", allGeoSites, 0644)
          	fmt.Println("‚úÖ geosite.dat generated successfully.")
          }
          EOF

      - name: Run Generator
        run: go run builder.go

      - name: Generate Checksum
        run: sha256sum geosite.dat > geosite.dat.sha256sum

      - name: Cleanup and Update Release
        run: |
          # –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ–ª–∏–∑–∞ –∏ —Ç–µ–≥–∞ —á–µ—Ä–µ–∑ API –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∞—Å—Å–µ—Ç–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏
          gh release delete latest --yes || true
          gh api -X DELETE /repos/${{ github.repository }}/git/refs/tags/latest || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Fresh Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "GeoSite Build: ${{ env.RELEASE_DATE }}"
          body: |
            ## üöÄ Manual GeoSite Build
            **Build Date:** ${{ env.RELEASE_DATE }} (MSK)
            
            ### üì¶ Included categories:
            ```
            $(ls data/)
            ```
          draft: false
          prerelease: false
          make_latest: true
          files: |
            geosite.dat
            geosite.dat.sha256sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
