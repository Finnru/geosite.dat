name: Build-GeoSite-Manual

on:
  workflow_dispatch: # Только ручной запуск кнопкой

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Prepare Environment
        run: |
          # Создаем папку data, если вы забыли её создать
          mkdir -p data
          # Генерируем дату сборки
          echo "RELEASE_DATE=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV

      - name: Create Generator Script
        run: |
          cat <<EOF > builder.go
          package main
          import (
          	"bufio"
          	"encoding/binary"
          	"fmt"
          	"log"
          	"os"
          	"path/filepath"
          	"strings"
          )
          func writeVarint(v uint32) []byte {
          	var buf [binary.MaxVarintLen32]byte
          	n := binary.PutUvarint(buf[:], uint64(v))
          	return buf[:n]
          }
          func encodeField(num int, wireType int, data []byte) []byte {
          	tag := uint32((num << 3) | wireType)
          	res := writeVarint(tag)
          	if wireType == 2 {
          		res = append(res, writeVarint(uint32(len(data)))...)
          	}
          	res = append(res, data...)
          	return res
          }
          func main() {
          	var allEntries []byte
          	files, err := os.ReadDir("./data")
          	if err != nil { log.Fatal(err) }
          	
          	for _, f := range files {
          		if f.IsDir() || strings.HasPrefix(f.Name(), ".") { continue }
          		
          		tagName := strings.ToLower(f.Name())
          		fmt.Printf("Packing category: %s\n", tagName)
          		
          		var sitesData []byte
          		file, _ := os.Open(filepath.Join("./data", f.Name()))
          		scanner := bufio.NewScanner(file)
          		
          		for scanner.Scan() {
          			line := strings.TrimSpace(scanner.Text())
          			// Игнорируем комментарии и пустые строки
          			if line == "" || strings.HasPrefix(line, "#") { continue }
          			
          			// Обрабатываем префиксы (domain:, full:, regexp:, keyword:)
          			// Если префикса нет, по умолчанию считаем "domain"
          			domainType := "domain"
          			domainValue := line
          			
          			if strings.Contains(line, ":") {
          				parts := strings.SplitN(line, ":", 2)
          				if parts[0] == "domain" || parts[0] == "full" || parts[0] == "regexp" || parts[0] == "keyword" {
          					domainType = parts[0]
          					domainValue = parts[1]
          				}
          			}

          			// Кодируем запись Site
          			siteEntry := encodeField(1, 2, []byte(domainType))
          			siteEntry = append(siteEntry, encodeField(2, 2, []byte(domainValue))...)
          			
          			// Добавляем Site в список сайтов этой категории
          			sitesData = append(sitesData, encodeField(2, 2, siteEntry)...)
          		}
          		file.Close()

          		// Кодируем структуру GeoSite (Name + List of Sites)
          		geoSite := encodeField(1, 2, []byte(tagName))
          		geoSite = append(geoSite, sitesData...)
          		
          		// Добавляем в общий список GeoSiteList
          		allEntries = append(allEntries, encodeField(1, 2, geoSite)...)
          	}
          	os.WriteFile("geosite.dat", allEntries, 0644)
          	fmt.Println("Success: geosite.dat generated.")
          }
          EOF

      - name: Run Generator
        run: go run builder.go

      - name: Generate Checksum
        run: sha256sum geosite.dat > geosite.dat.sha256sum

      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "GeoSite Build: ${{ env.RELEASE_DATE }}"
          body: |
            Manual build of geosite.dat.
            Included categories: $(ls data | xargs)
          draft: false
          prerelease: false
          make_latest: true
          files: |
            geosite.dat
            geosite.dat.sha256sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
